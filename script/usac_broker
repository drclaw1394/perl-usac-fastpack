#!/usr/bin/env usac --backend AnyEvent
#

use v5.36;
use uSAC::IO;
use uSAC::FastPack::Broker;
use Data::Dumper;

my $node=uSAC::FastPack::Broker->new;

my %config;

my $l="po=6123,t=stream,f=INET\$,i=lo";



# Create 
sub do_connect;


$node->on_ready=sub {
  asay $STDERR, "Server running";
};

$node->on_bridge=sub {
 asay $STDERR, "GOT a new bridge:";
 $node->listen("test", $_[0]);
 
 ###############################################
 # $node->listen(undef, "test", sub {          #
 #     asay $STDERR, "GOT MESSAGE ".Dumper @_; #
 #     $STDERR->flush();                       #
 #     });                                     #
 ###############################################
};

$node->server($l);

timer 0, 1, sub {
  asay $STDERR , "timer ";
  $node->broadcast(undef, "test", "value");
  $STDERR->flush();
};

$node->listen(undef, "test", sub {
      asay $STDERR, "GOT MESSAGE ".Dumper @_;
      $STDERR->flush();
});



asay $STDERR, "AT THE END";

1;
